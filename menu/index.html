<script>
  // --- State ---
  let allCategories = [];
  let currentProducts = []; // المنتجات الحالية المعروضة فقط
  let activeCategory = 0;

  let currentProduct = null;
  let selectedPrimaryOption = null;
  let cart = [];
  let qty = 1;

  // --- Init ---
  window.onload = async () => {
    // التحميل الأولي (بدون ID ليجلب الفئات + منتجات أول فئة)
    await loadData(0);
  };

  // دالة موحدة لجلب البيانات
  async function loadData(catId) {
    // إظهار لودينج بسيط (اختياري)
    document.getElementById("products-grid").innerHTML =
      '<div class="col-span-full text-center py-10 text-gray-400">جاري التحميل...</div>';

    try {
      // بناء الرابط
      let url = "api.php";
      if (catId > 0) url += `?cat_id=${catId}`;

      const res = await fetch(url);
      const data = await res.json();

      // تحديث الفئات (فقط في المرة الأولى أو دائماً حسب الرغبة)
      if (data.categories) {
        allCategories = data.categories;
        renderCategories();
      }

      // تحديث الفئة النشطة الحالية التي رد بها السيرفر
      if (data.active_category) {
        activeCategory = data.active_category;
        renderCategories(); // لإعادة تلوين الأزرار
      }

      // تحديث المنتجات
      currentProducts = data.products || [];
      renderHome();
    } catch (e) {
      console.error(e);
      document.getElementById("products-grid").innerHTML =
        '<div class="col-span-full text-center text-red-500">فشل الاتصال بالسيرفر</div>';
    }
  }

  // --- Render Categories (بدون زر الكل) ---
  function renderCategories() {
    const container = document.getElementById("categories-container");

    // لا نضيف زر "الكل"، نبدأ مباشرة من الفئات القادمة من الداتابيس
    container.innerHTML = allCategories
      .map(
        (c) => `
            <button onclick="setCat('${c.id}')" 
                class="px-6 py-2 rounded-full whitespace-nowrap text-sm font-bold transition-all 
                ${
                  activeCategory == c.id
                    ? "bg-orange-600 text-white shadow-md scale-105"
                    : "bg-gray-100 text-gray-600 hover:bg-gray-200"
                }">
                ${c.name}
            </button>
        `
      )
      .join("");
  }

  // عند الضغط على فئة، نعيد طلب البيانات من السيرفر
  function setCat(id) {
    if (id == activeCategory) return; // لا تطلب نفس الفئة مرتين
    loadData(id);
  }

  // --- Render Products ---
  function renderHome() {
    const grid = document.getElementById("products-grid");

    if (currentProducts.length === 0) {
      grid.innerHTML =
        '<div class="col-span-full text-center py-10 text-gray-400">لا توجد منتجات في هذا القسم</div>';
      return;
    }

    grid.innerHTML = currentProducts
      .map(
        (p) => `
            <div onclick="showProductPage(${p.id})" class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 cursor-pointer active:scale-95 transition group">
                <div class="h-32 w-full overflow-hidden rounded-xl mb-3 bg-gray-50 relative">
                    <img src="${p.image_url}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500" onerror="this.src='https://via.placeholder.com/300'">
                </div>
                <h3 class="font-bold text-gray-800 text-sm mb-1">${p.name}</h3>
                <p class="text-xs text-gray-400 truncate">${p.description}</p>
            </div>
        `
      )
      .join("");
  }

  // --- Navigation & Modal Logic (نفس الكود السابق مع تعديل بسيط للمصدر) ---
  function showProductPage(pid) {
    // البحث في المنتجات المحملة حالياً
    currentProduct = currentProducts.find((p) => p.id == pid);
    if (!currentProduct) return;

    // تعبئة الصفحة
    document.getElementById("p-page-img").src = currentProduct.image_url;
    document.getElementById("p-page-title").innerText = currentProduct.name;
    document.getElementById("p-page-desc").innerText =
      currentProduct.description;

    const modifiers = currentProduct.modifiers || [];
    const primaryContainer = document.getElementById("primary-options-grid");

    if (modifiers.length > 0) {
      // المجموعة الأولى (غالباً الأحجام/الأنواع من جدول productOptions)
      const firstGroup = modifiers[0];

      primaryContainer.innerHTML = firstGroup.options
        .map(
          (opt) => `
                <div onclick="selectPrimaryOption(${opt.price}, '${opt.name}')" 
                        class="flex justify-between items-center p-4 border border-gray-200 rounded-xl hover:border-orange-500 hover:bg-orange-50 cursor-pointer transition shadow-sm bg-white mb-3">
                    <div class="flex items-center gap-3">
                        <div class="w-5 h-5 rounded-full border-2 border-gray-300 flex items-center justify-center">
                            <div class="w-2.5 h-2.5 rounded-full bg-orange-600 opacity-0"></div> 
                        </div>
                        <span class="font-bold text-gray-700">${opt.name}</span>
                    </div>
                    <span class="font-bold text-orange-600">${opt.price} ريال</span>
                </div>
            `
        )
        .join("");
    } else {
      // منتج بدون خيارات (سعر ثابت)
      primaryContainer.innerHTML = `
                <div onclick="selectPrimaryOption(${currentProduct.price}, 'Default')" 
                        class="w-full bg-orange-600 text-white p-4 rounded-xl font-bold text-center shadow-lg cursor-pointer">
                    اطلب الآن (${currentProduct.price} ريال)
                </div>
            `;
    }

    document.getElementById("view-home").classList.remove("active");
    document.getElementById("view-product").classList.add("active");
    window.scrollTo(0, 0);
  }

  function goHome() {
    document.getElementById("view-product").classList.remove("active");
    document.getElementById("view-home").classList.add("active");
  }

  function selectPrimaryOption(price, name) {
    selectedPrimaryOption = { name: name, price: parseFloat(price) };
    qty = 1;

    document.getElementById(
      "selected-variant-name"
    ).innerText = `${currentProduct.name} - ${name}`;
    document.getElementById("final-qty").innerText = 1;

    const modifiers = currentProduct.modifiers || [];
    const container = document.getElementById("secondary-options-container");

    // تخطي المجموعة الأولى لأننا اخترناها، وعرض الباقي (من جدول productAddons)
    const addOnsGroups = modifiers.slice(1);

    if (addOnsGroups.length === 0) {
      container.innerHTML =
        '<div class="text-center text-gray-400 py-10">لا توجد إضافات أخرى لهذا الصنف</div>';
    } else {
      container.innerHTML = addOnsGroups
        .map(
          (grp, gIdx) => `
                <div class="mb-6">
                    <h4 class="font-bold text-gray-800 mb-3 text-sm bg-gray-100 inline-block px-3 py-1 rounded-lg">${
                      grp.title
                    }</h4>
                    <div class="space-y-3">
                        ${grp.options
                          .map(
                            (opt, oIdx) => `
                            <label class="flex items-center justify-between p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition">
                                <div class="flex items-center gap-3">
                                    <input type="${grp.type}" name="addon_${gIdx}" data-price="${opt.price}" class="w-5 h-5 accent-orange-600" onchange="calcTotal()">
                                    <span class="text-gray-700 font-medium">${opt.name}</span>
                                </div>
                                <span class="text-gray-500 text-sm font-bold text-orange-600">+${opt.price}</span>
                            </label>
                        `
                          )
                          .join("")}
                    </div>
                </div>
            `
        )
        .join("");
    }

    document.getElementById("addons-modal").classList.remove("hidden");
    calcTotal();
  }

  function closeAddons() {
    document.getElementById("addons-modal").classList.add("hidden");
  }

  function updateQty(n) {
    if (qty + n >= 1) {
      qty += n;
      document.getElementById("final-qty").innerText = qty;
      calcTotal();
    }
  }

  function calcTotal() {
    let addonsTotal = 0;
    document
      .querySelectorAll("#secondary-options-container input:checked")
      .forEach((i) => {
        addonsTotal += parseFloat(i.dataset.price);
      });

    const total = (selectedPrimaryOption.price + addonsTotal) * qty;
    document.getElementById("final-price-btn").innerText =
      total.toFixed(2) + " ريال";
    return total;
  }

  function addToCart() {
    const finalPrice = calcTotal();

    cart.push({
      product: currentProduct.name,
      variant: selectedPrimaryOption.name,
      qty: qty,
      total: finalPrice,
    });

    const totalCartValue = cart.reduce((sum, item) => sum + item.total, 0);
    const totalCartCount = cart.reduce((sum, item) => sum + item.qty, 0);

    document.getElementById("home-cart-count").innerText = totalCartCount;
    document.getElementById("float-count").innerText = totalCartCount;
    document.getElementById("float-total").innerText =
      totalCartValue.toFixed(2) + " ريال";

    document.getElementById("sticky-cart").classList.remove("hidden");

    closeAddons();
    goHome();
  }
</script>
