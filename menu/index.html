<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Ø§Ù„Ù…Ø·Ø¹Ù… Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Tajawal", sans-serif;
        background-color: #f8f9fa;
        user-select: none;
      }
      .hide-scroll::-webkit-scrollbar {
        display: none;
      }

      /* ØªÙ†Ù‚Ù„ Ø§Ù„ØµÙØ­Ø§Øª (Transitions) */
      .page-section {
        transition: transform 0.3s ease-in-out, opacity 0.3s;
        position: absolute;
        width: 100%;
        top: 0;
        left: 0;
        min-height: 100vh;
        background: #f8f9fa;
        display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
      }
      .page-section.active {
        display: block;
        animation: fadeIn 0.3s;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.98);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      @keyframes slideUp {
        from {
          transform: translateY(100%);
        }
        to {
          transform: translateY(0);
        }
      }

      .modal-up {
        animation: slideUp 0.3s cubic-bezier(0.165, 0.84, 0.44, 1) forwards;
      }
    </style>
  </head>
  <body class="pb-20">
    <div id="view-home" class="page-section active relative">
      <header class="sticky top-0 z-10 bg-white shadow-sm pb-2">
        <div class="flex justify-between items-center p-4">
          <h1 class="text-xl font-bold text-gray-800">ğŸ” Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</h1>
          <div class="relative bg-orange-100 p-2 rounded-full">
            <span class="text-xl">ğŸ›’</span>
            <span
              id="home-cart-count"
              class="absolute -top-1 -right-1 bg-red-600 text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full"
              >0</span
            >
          </div>
        </div>
        <div
          class="flex overflow-x-auto gap-3 px-4 hide-scroll"
          id="categories-container"
        ></div>
      </header>

      <main
        class="p-4 grid grid-cols-2 md:grid-cols-3 gap-4"
        id="products-grid"
      ></main>
    </div>

    <div id="view-product" class="page-section bg-white z-20">
      <div class="absolute top-4 right-4 z-30">
        <button
          onclick="goHome()"
          class="bg-white/90 backdrop-blur p-3 rounded-full shadow-lg text-gray-700 font-bold hover:bg-gray-100 transition"
        >
          âœ• Ø¥ØºÙ„Ø§Ù‚
        </button>
      </div>

      <div class="h-[40vh] w-full relative">
        <img id="p-page-img" src="" class="w-full h-full object-cover" />
        <div
          class="absolute inset-0 bg-gradient-to-t from-white to-transparent"
        ></div>
      </div>

      <div class="px-5 -mt-10 relative z-10">
        <h1
          id="p-page-title"
          class="text-3xl font-extrabold text-gray-800 mb-2"
        ></h1>
        <p
          id="p-page-desc"
          class="text-gray-500 leading-relaxed text-sm mb-6"
        ></p>

        <div class="border-t border-gray-100 pt-6">
          <h3 class="font-bold text-gray-800 mb-4 text-lg">
            Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹ / Ø§Ù„Ø­Ø¬Ù…:
          </h3>
          <div id="primary-options-grid" class="space-y-3"></div>
        </div>
      </div>
    </div>

    <div id="addons-modal" class="fixed inset-0 z-50 hidden">
      <div
        class="absolute inset-0 bg-black/50 backdrop-blur-sm transition-opacity"
        onclick="closeAddons()"
      ></div>
      <div
        class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-2xl h-[75vh] flex flex-col modal-up"
      >
        <div
          class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-3xl"
        >
          <div>
            <span class="text-xs text-gray-500 block">Ù„Ù‚Ø¯ Ø§Ø®ØªØ±Øª:</span>
            <span
              id="selected-variant-name"
              class="font-bold text-gray-800 text-lg"
            ></span>
          </div>
          <button onclick="closeAddons()" class="text-gray-400 text-2xl">
            âœ•
          </button>
        </div>

        <div
          class="flex-1 overflow-y-auto p-5"
          id="secondary-options-container"
        ></div>

        <div class="p-4 border-t border-gray-100 bg-white">
          <div class="flex justify-center items-center gap-6 mb-4">
            <button
              onclick="updateQty(-1)"
              class="w-10 h-10 border rounded-full text-xl font-bold"
            >
              -
            </button>
            <span id="final-qty" class="text-xl font-bold">1</span>
            <button
              onclick="updateQty(1)"
              class="w-10 h-10 bg-black text-white rounded-full text-xl font-bold"
            >
              +
            </button>
          </div>
          <button
            onclick="addToCart()"
            class="w-full bg-orange-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg flex justify-between px-6 active:scale-95 transition"
          >
            <span>Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©</span>
            <span id="final-price-btn">0 Ø±ÙŠØ§Ù„</span>
          </button>
        </div>
      </div>
    </div>

    <div id="sticky-cart" class="fixed bottom-4 left-4 right-4 z-40 hidden">
      <button
        class="w-full bg-green-600 text-white p-4 rounded-xl shadow-lg flex justify-between font-bold"
      >
        <div class="flex items-center gap-2">
          <span
            class="bg-white/20 px-3 py-1 rounded-full text-sm"
            id="float-count"
            >0</span
          >
          <span>Ø¹Ø±Ø¨Ø© Ø§Ù„ØªØ³ÙˆÙ‚</span>
        </div>
        <span id="float-total">0 Ø±ÙŠØ§Ù„</span>
      </button>
    </div>

    <script>
      // --- State ---
      let allCategories = [];
      let allProducts = [];
      let activeCategory = "all";

      let currentProduct = null;
      let selectedPrimaryOption = null; // Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (Ù…Ø«Ù„ Ø§Ù„Ø­Ø¬Ù…)
      let cart = [];
      let qty = 1;

      // --- Init ---
      window.onload = async () => {
        try {
          // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…Ù„Ù Ø§Ù„Ù€ PHP
          const res = await fetch("api.php");
          const data = await res.json();
          allCategories = [{ id: "all", name: "Ø§Ù„ÙƒÙ„" }, ...data.categories];
          allProducts = data.products;

          renderCategories();
          renderHome();
        } catch (e) {
          console.error(e);
          alert("ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±");
        }
      };

      // --- Render Home ---
      function renderCategories() {
        document.getElementById("categories-container").innerHTML =
          allCategories
            .map(
              (c) => `
                <button onclick="setCat('${
                  c.id
                }')" class="px-6 py-2 rounded-full whitespace-nowrap text-sm font-bold transition ${
                activeCategory == c.id
                  ? "bg-orange-600 text-white shadow-md"
                  : "bg-gray-200 text-gray-600"
              }">
                    ${c.name}
                </button>
            `
            )
            .join("");
      }

      function setCat(id) {
        activeCategory = id;
        renderCategories();
        renderHome();
      }

      function renderHome() {
        const list =
          activeCategory == "all"
            ? allProducts
            : allProducts.filter((p) => p.cat_id == activeCategory);
        document.getElementById("products-grid").innerHTML = list
          .map(
            (p) => `
                <div onclick="showProductPage(${p.id})" class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 cursor-pointer active:scale-95 transition">
                    <img src="${p.image_url}" class="w-full h-32 object-cover rounded-xl mb-3 bg-gray-100">
                    <h3 class="font-bold text-gray-800 text-sm mb-1">${p.name}</h3>
                    <p class="text-xs text-gray-400 truncate">${p.description}</p>
                </div>
            `
          )
          .join("");
      }

      // --- Navigation Logic ---
      function showProductPage(pid) {
        currentProduct = allProducts.find((p) => p.id == pid);
        if (!currentProduct) return;

        // ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙØ­Ø©
        document.getElementById("p-page-img").src = currentProduct.image_url;
        document.getElementById("p-page-title").innerText = currentProduct.name;
        document.getElementById("p-page-desc").innerText =
          currentProduct.description;

        // Ù…Ù†Ø·Ù‚ ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª:
        // Ù†ÙØªØ±Ø¶ Ø£Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ (Index 0) Ù‡ÙŠ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ù…Ø«Ù„ Ø§Ù„Ø£Ø­Ø¬Ø§Ù…) Ø§Ù„ØªÙŠ Ø³ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ØµÙØ­Ø©
        // ÙˆØ¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø³ØªØ¸Ù‡Ø± Ù„Ø§Ø­Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
        const modifiers = currentProduct.modifiers || [];
        const primaryContainer = document.getElementById(
          "primary-options-grid"
        );

        if (modifiers.length > 0) {
          // Ù†Ø£Ø®Ø° Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙÙ‚Ø· Ù„Ù„Ø¹Ø±Ø¶ Ù‡Ù†Ø§
          const firstGroup = modifiers[0];

          primaryContainer.innerHTML = firstGroup.options
            .map(
              (opt) => `
                    <div onclick="selectPrimaryOption(${opt.price}, '${opt.name}')" 
                         class="flex justify-between items-center p-4 border border-gray-200 rounded-xl hover:border-orange-500 hover:bg-orange-50 cursor-pointer transition shadow-sm bg-white">
                        <div class="flex items-center gap-3">
                            <div class="w-5 h-5 rounded-full border-2 border-gray-300 flex items-center justify-center">
                                <div class="w-2.5 h-2.5 rounded-full bg-orange-600 opacity-0"></div> 
                            </div>
                            <span class="font-bold text-gray-700">${opt.name}</span>
                        </div>
                        <span class="font-bold text-orange-600">${opt.price} Ø±ÙŠØ§Ù„</span>
                    </div>
                `
            )
            .join("");
        } else {
          // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø®ÙŠØ§Ø±Ø§ØªØŒ Ù†Ø¶Ø¹ Ø²Ø± ÙˆØ§Ø­Ø¯ Ù„Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
          primaryContainer.innerHTML = `
                    <div onclick="selectPrimaryOption(${currentProduct.price}, 'Standard')" 
                         class="w-full bg-orange-600 text-white p-4 rounded-xl font-bold text-center shadow-lg cursor-pointer">
                        Ø·Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬ (${currentProduct.price} Ø±ÙŠØ§Ù„)
                    </div>
                `;
        }

        // Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ù„Ù„ØµÙØ­Ø©
        document.getElementById("view-home").classList.remove("active");
        document.getElementById("view-product").classList.add("active");
        window.scrollTo(0, 0);
      }

      function goHome() {
        document.getElementById("view-product").classList.remove("active");
        document.getElementById("view-home").classList.add("active");
      }

      // --- Step 3: Add-ons Modal Logic ---
      function selectPrimaryOption(price, name) {
        selectedPrimaryOption = { name: name, price: parseFloat(price) };
        qty = 1;

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
        document.getElementById(
          "selected-variant-name"
        ).innerText = `${currentProduct.name} - ${name}`;
        document.getElementById("final-qty").innerText = 1;

        // Ø¹Ø±Ø¶ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª (Add-ons) ÙÙ‚Ø·
        const modifiers = currentProduct.modifiers || [];
        const container = document.getElementById(
          "secondary-options-container"
        );

        // Ù†ØªØ®Ø·Ù‰ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ù„Ø£Ù†Ù†Ø§ Ø§Ø®ØªØ±Ù†Ø§Ù‡Ø§ Ø¨Ø§Ù„ÙØ¹Ù„
        const addOnsGroups = modifiers.slice(1);

        if (addOnsGroups.length === 0) {
          container.innerHTML =
            '<div class="text-center text-gray-400 py-10">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¶Ø§ÙØ§Øª Ø£Ø®Ø±Ù‰ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</div>';
        } else {
          container.innerHTML = addOnsGroups
            .map(
              (grp, gIdx) => `
                    <div class="mb-6">
                        <h4 class="font-bold text-gray-800 mb-3 text-sm bg-gray-100 inline-block px-3 py-1 rounded-lg">${
                          grp.title
                        }</h4>
                        <div class="space-y-3">
                            ${grp.options
                              .map(
                                (opt, oIdx) => `
                                <label class="flex items-center justify-between p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                    <div class="flex items-center gap-3">
                                        <input type="${grp.type}" name="addon_${gIdx}" data-price="${opt.price}" class="w-5 h-5 accent-orange-600" onchange="calcTotal()">
                                        <span class="text-gray-700 font-medium">${opt.name}</span>
                                    </div>
                                    <span class="text-gray-500 text-sm">+${opt.price}</span>
                                </label>
                            `
                              )
                              .join("")}
                        </div>
                    </div>
                `
            )
            .join("");
        }

        // ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
        document.getElementById("addons-modal").classList.remove("hidden");
        calcTotal();
      }

      function closeAddons() {
        document.getElementById("addons-modal").classList.add("hidden");
      }

      function updateQty(n) {
        if (qty + n >= 1) {
          qty += n;
          document.getElementById("final-qty").innerText = qty;
          calcTotal();
        }
      }

      function calcTotal() {
        let addonsTotal = 0;
        document
          .querySelectorAll("#secondary-options-container input:checked")
          .forEach((i) => {
            addonsTotal += parseFloat(i.dataset.price);
          });

        const total = (selectedPrimaryOption.price + addonsTotal) * qty;
        document.getElementById("final-price-btn").innerText =
          total.toFixed(2) + " Ø±ÙŠØ§Ù„";
        return total;
      }

      function addToCart() {
        const finalPrice = calcTotal(); // Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ±

        // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø¹Ø±Ø¨Ø© (Ù…Ø­Ø§ÙƒØ§Ø©)
        cart.push({
          product: currentProduct.name,
          variant: selectedPrimaryOption.name,
          qty: qty,
          total: finalPrice,
        });

        // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³Ù„Ø© ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        const totalCartValue = cart.reduce((sum, item) => sum + item.total, 0);
        const totalCartCount = cart.reduce((sum, item) => sum + item.qty, 0);

        document.getElementById("home-cart-count").innerText = totalCartCount;
        document.getElementById("float-count").innerText = totalCartCount;
        document.getElementById("float-total").innerText =
          totalCartValue.toFixed(2) + " Ø±ÙŠØ§Ù„";

        document.getElementById("sticky-cart").classList.remove("hidden");

        // Ø¥ØºÙ„Ø§Ù‚ ÙƒÙ„ Ø´ÙŠØ¡ ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        closeAddons();
        goHome();
      }
    </script>
  </body>
</html>
