<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ø¹Ø§Ù…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Tajawal", sans-serif;
        background-color: #f8f9fa;
        user-select: none;
      }
      .hide-scroll::-webkit-scrollbar {
        display: none;
      }

      /* ØªÙ†Ù‚Ù„ Ø§Ù„ØµÙØ­Ø§Øª */
      .page-section {
        transition: transform 0.3s ease-in-out, opacity 0.3s;
        position: absolute;
        width: 100%;
        top: 0;
        left: 0;
        min-height: 100vh;
        background: #f8f9fa;
        display: none;
      }
      .page-section.active {
        display: block;
        animation: fadeIn 0.3s;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.98);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      @keyframes slideUp {
        from {
          transform: translateY(100%);
        }
        to {
          transform: translateY(0);
        }
      }

      .modal-up {
        animation: slideUp 0.3s cubic-bezier(0.165, 0.84, 0.44, 1) forwards;
      }
    </style>
  </head>
  <body class="pb-20 bg-gray-50">
    <div id="view-home" class="page-section active relative">
      <header class="sticky top-0 z-10 bg-white shadow-sm pb-2">
        <div class="flex justify-between items-center p-4">
          <h1 class="text-xl font-bold text-gray-800">ğŸ” Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</h1>
          <div class="relative bg-orange-100 p-2 rounded-full">
            <span class="text-xl">ğŸ›’</span>
            <span
              id="home-cart-count"
              class="absolute -top-1 -right-1 bg-red-600 text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full"
              >0</span
            >
          </div>
        </div>

        <div
          class="flex overflow-x-auto gap-3 px-4 hide-scroll"
          id="categories-container"
        >
          <div class="text-gray-400 text-sm px-2">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ¦Ø§Øª...</div>
        </div>
      </header>

      <main
        class="p-4 grid grid-cols-2 md:grid-cols-3 gap-4"
        id="products-grid"
      ></main>
    </div>

    <div id="view-product" class="page-section bg-white z-20">
      <div class="absolute top-4 right-4 z-30">
        <button
          onclick="goHome()"
          class="bg-white/90 backdrop-blur p-2 px-4 rounded-full shadow-lg text-gray-700 font-bold hover:bg-gray-100 text-sm"
        >
          âœ• Ø¥ØºÙ„Ø§Ù‚
        </button>
      </div>

      <div class="h-[40vh] w-full relative">
        <img
          id="p-page-img"
          src=""
          class="w-full h-full object-cover"
          onerror="this.src='https://via.placeholder.com/300'"
        />
        <div
          class="absolute inset-0 bg-gradient-to-t from-white to-transparent"
        ></div>
      </div>

      <div class="px-5 -mt-10 relative z-10">
        <h1
          id="p-page-title"
          class="text-2xl font-extrabold text-gray-800 mb-2"
        ></h1>
        <p
          id="p-page-desc"
          class="text-gray-500 leading-relaxed text-sm mb-6"
        ></p>

        <div class="border-t border-gray-100 pt-6">
          <h3 class="font-bold text-gray-800 mb-4 text-lg">
            Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹ / Ø§Ù„Ø­Ø¬Ù…:
          </h3>
          <div id="primary-options-grid" class="space-y-3"></div>
        </div>
      </div>
    </div>

    <div id="addons-modal" class="fixed inset-0 z-50 hidden">
      <div
        class="absolute inset-0 bg-black/50 backdrop-blur-sm transition-opacity"
        onclick="closeAddons()"
      ></div>
      <div
        class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-2xl h-[75vh] flex flex-col modal-up"
      >
        <div
          class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-3xl"
        >
          <div>
            <span class="text-xs text-gray-500 block">Ù„Ù‚Ø¯ Ø§Ø®ØªØ±Øª:</span>
            <span
              id="selected-variant-name"
              class="font-bold text-gray-800 text-sm"
            ></span>
          </div>
          <button onclick="closeAddons()" class="text-gray-400 text-xl">
            âœ•
          </button>
        </div>

        <div
          class="flex-1 overflow-y-auto p-5"
          id="secondary-options-container"
        ></div>

        <div class="p-4 border-t border-gray-100 bg-white">
          <div class="flex justify-center items-center gap-6 mb-4">
            <button
              onclick="updateQty(-1)"
              class="w-10 h-10 border rounded-full text-xl font-bold"
            >
              -
            </button>
            <span id="final-qty" class="text-xl font-bold">1</span>
            <button
              onclick="updateQty(1)"
              class="w-10 h-10 bg-gray-800 text-white rounded-full text-xl font-bold"
            >
              +
            </button>
          </div>
          <button
            onclick="addToCart()"
            class="w-full bg-orange-600 text-white py-3 rounded-xl font-bold text-lg shadow-lg flex justify-between px-6 active:scale-95 transition"
          >
            <span>Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©</span>
            <span id="final-price-btn">0 Ø±ÙŠØ§Ù„</span>
          </button>
        </div>
      </div>
    </div>

    <div id="sticky-cart" class="fixed bottom-4 left-4 right-4 z-40 hidden">
      <button
        class="w-full bg-green-600 text-white p-4 rounded-xl shadow-lg flex justify-between font-bold"
      >
        <div class="flex items-center gap-2">
          <span
            class="bg-white/20 px-3 py-1 rounded-full text-sm"
            id="float-count"
            >0</span
          >
          <span>Ø¹Ø±Ø¨Ø© Ø§Ù„ØªØ³ÙˆÙ‚</span>
        </div>
        <span id="float-total">0 Ø±ÙŠØ§Ù„</span>
      </button>
    </div>

    <script>
      // --- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ---
      let allCategories = [];
      let currentProducts = [];
      let activeCategory = 0;

      let currentProduct = null;
      let selectedPrimaryOption = null;
      let cart = [];
      let qty = 1;

      // --- Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ---
      window.onload = async () => {
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© (Ø¨Ø¯ÙˆÙ† ÙÙ„ØªØ± Ù„Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙ„)
        await loadData(0);
      };

      // Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† api.php
      async function loadData(catId) {
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù†ØµØ± Ù‚Ø¨Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„ÙŠÙ‡ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø®Ø·Ø£
        const grid = document.getElementById("products-grid");
        if (grid)
          grid.innerHTML =
            '<div class="col-span-full text-center py-10 text-gray-400">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';

        try {
          let url = "api.php";
          if (catId > 0) url += `?cat_id=${catId}`;

          const res = await fetch(url);
          const data = await res.json();

          // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          if (data.error) {
            alert("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + data.error);
            return;
          }

          // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ¦Ø§Øª
          if (data.categories) {
            allCategories = data.categories;
            renderCategories();
          }

          // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù†Ø´Ø·Ø©
          if (data.active_category) {
            activeCategory = data.active_category;
            renderCategories();
          }

          // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
          currentProducts = data.products || [];
          renderHome();
        } catch (e) {
          console.error(e);
          if (grid)
            grid.innerHTML =
              '<div class="col-span-full text-center text-red-500 py-10">ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± (ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ XAMPP)</div>';
        }
      }

      // Ø±Ø³Ù… Ø§Ù„ÙØ¦Ø§Øª
      function renderCategories() {
        const container = document.getElementById("categories-container");
        if (!container) return; // Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø®Ø·Ø£

        container.innerHTML = allCategories
          .map(
            (c) => `
                <button onclick="setCat('${c.id}')" 
                    class="px-6 py-2 rounded-full whitespace-nowrap text-sm font-bold transition-all 
                    ${
                      activeCategory == c.id
                        ? "bg-orange-600 text-white shadow-md scale-105"
                        : "bg-gray-100 text-gray-600 hover:bg-gray-200"
                    }">
                    ${c.name}
                </button>
            `
          )
          .join("");
      }

      // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ÙØ¦Ø©
      function setCat(id) {
        if (id == activeCategory) return;
        loadData(id);
      }

      // Ø±Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
      function renderHome() {
        const grid = document.getElementById("products-grid");
        if (!grid) return;

        if (currentProducts.length === 0) {
          grid.innerHTML =
            '<div class="col-span-full text-center py-10 text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…</div>';
          return;
        }

        grid.innerHTML = currentProducts
          .map(
            (p) => `
                <div onclick="showProductPage(${
                  p.id
                })" class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 cursor-pointer active:scale-95 transition group">
                    <div class="h-32 w-full overflow-hidden rounded-xl mb-3 bg-gray-50 relative">
                        <img src="${
                          p.image_url
                        }" class="w-full h-full object-cover group-hover:scale-110 transition duration-500" onerror="this.src='https://via.placeholder.com/300'">
                    </div>
                    <h3 class="font-bold text-gray-800 text-sm mb-1 line-clamp-1">${
                      p.name
                    }</h3>
                    <p class="text-xs text-gray-400 truncate">${
                      p.description || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ"
                    }</p>
                </div>
            `
          )
          .join("");
      }

      // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬
      function showProductPage(pid) {
        currentProduct = currentProducts.find((p) => p.id == pid);
        if (!currentProduct) return;

        // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        document.getElementById("p-page-img").src = currentProduct.image_url;
        document.getElementById("p-page-title").innerText = currentProduct.name;
        document.getElementById("p-page-desc").innerText =
          currentProduct.description;

        const modifiers = currentProduct.modifiers || [];
        const primaryContainer = document.getElementById(
          "primary-options-grid"
        );

        if (modifiers.length > 0) {
          // Ø¹Ø±Ø¶ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ - Ø§Ù„Ø£Ø­Ø¬Ø§Ù…)
          const firstGroup = modifiers[0];

          primaryContainer.innerHTML = firstGroup.options
            .map(
              (opt) => `
                    <div onclick="selectPrimaryOption(${opt.price}, '${opt.name}')" 
                            class="flex justify-between items-center p-4 border border-gray-200 rounded-xl hover:border-orange-500 hover:bg-orange-50 cursor-pointer transition shadow-sm bg-white mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-5 h-5 rounded-full border-2 border-gray-300 flex items-center justify-center">
                                <div class="w-2.5 h-2.5 rounded-full bg-orange-600 opacity-0"></div> 
                            </div>
                            <span class="font-bold text-gray-700">${opt.name}</span>
                        </div>
                        <span class="font-bold text-orange-600">${opt.price} Ø±ÙŠØ§Ù„</span>
                    </div>
                `
            )
            .join("");
        } else {
          // Ù…Ù†ØªØ¬ Ø¨Ø³Ø¹Ø± Ø«Ø§Ø¨Øª Ø¨Ø¯ÙˆÙ† Ø®ÙŠØ§Ø±Ø§Øª
          primaryContainer.innerHTML = `
                    <div onclick="selectPrimaryOption(${currentProduct.price}, 'Default')" 
                            class="w-full bg-orange-600 text-white p-4 rounded-xl font-bold text-center shadow-lg cursor-pointer">
                        Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù† (${currentProduct.price} Ø±ÙŠØ§Ù„)
                    </div>
                `;
        }

        // Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ù€ Views
        document.getElementById("view-home").classList.remove("active");
        document.getElementById("view-product").classList.add("active");
        window.scrollTo(0, 0);
      }

      // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
      function goHome() {
        document.getElementById("view-product").classList.remove("active");
        document.getElementById("view-home").classList.add("active");
      }

      // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ø¬Ù…/Ø§Ù„Ù†ÙˆØ¹ -> ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª
      function selectPrimaryOption(price, name) {
        selectedPrimaryOption = { name: name, price: parseFloat(price) };
        qty = 1;

        document.getElementById(
          "selected-variant-name"
        ).innerText = `${currentProduct.name} - ${name}`;
        document.getElementById("final-qty").innerText = 1;

        const modifiers = currentProduct.modifiers || [];
        const container = document.getElementById(
          "secondary-options-container"
        );

        // Ø¹Ø±Ø¶ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª (Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª)
        const addOnsGroups = modifiers.slice(1);

        if (addOnsGroups.length === 0) {
          container.innerHTML =
            '<div class="text-center text-gray-400 py-10">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¶Ø§ÙØ§Øª Ø£Ø®Ø±Ù‰ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</div>';
        } else {
          container.innerHTML = addOnsGroups
            .map(
              (grp, gIdx) => `
                    <div class="mb-6">
                        <h4 class="font-bold text-gray-800 mb-3 text-sm bg-gray-100 inline-block px-3 py-1 rounded-lg">${
                          grp.title
                        }</h4>
                        <div class="space-y-3">
                            ${grp.options
                              .map(
                                (opt, oIdx) => `
                                <label class="flex items-center justify-between p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition">
                                    <div class="flex items-center gap-3">
                                        <input type="${grp.type}" name="addon_${gIdx}" data-price="${opt.price}" class="w-5 h-5 accent-orange-600" onchange="calcTotal()">
                                        <span class="text-gray-700 font-medium">${opt.name}</span>
                                    </div>
                                    <span class="text-gray-500 text-sm font-bold text-orange-600">+${opt.price}</span>
                                </label>
                            `
                              )
                              .join("")}
                        </div>
                    </div>
                `
            )
            .join("");
        }

        document.getElementById("addons-modal").classList.remove("hidden");
        calcTotal();
      }

      function closeAddons() {
        document.getElementById("addons-modal").classList.add("hidden");
      }

      function updateQty(n) {
        if (qty + n >= 1) {
          qty += n;
          document.getElementById("final-qty").innerText = qty;
          calcTotal();
        }
      }

      function calcTotal() {
        let addonsTotal = 0;
        document
          .querySelectorAll("#secondary-options-container input:checked")
          .forEach((i) => {
            addonsTotal += parseFloat(i.dataset.price);
          });

        const total = (selectedPrimaryOption.price + addonsTotal) * qty;
        document.getElementById("final-price-btn").innerText =
          total.toFixed(2) + " Ø±ÙŠØ§Ù„";
        return total;
      }

      function addToCart() {
        const finalPrice = calcTotal();

        cart.push({
          product: currentProduct.name,
          variant: selectedPrimaryOption.name,
          qty: qty,
          total: finalPrice,
        });

        const totalCartValue = cart.reduce((sum, item) => sum + item.total, 0);
        const totalCartCount = cart.reduce((sum, item) => sum + item.qty, 0);

        document.getElementById("home-cart-count").innerText = totalCartCount;
        document.getElementById("float-count").innerText = totalCartCount;
        document.getElementById("float-total").innerText =
          totalCartValue.toFixed(2) + " Ø±ÙŠØ§Ù„";

        document.getElementById("sticky-cart").classList.remove("hidden");

        closeAddons();
        goHome();
      }
    </script>
  </body>
</html>
